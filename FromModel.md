## 从模型到功能

产品介绍 github地址：https://github.com/blueskylong/aolie_illustrate

从通常的后台程序开发中，操作数据库，保持数据的正确性，完整性是我们开发系统的主要工作。所以数据及其关系，就是我们后台开发的主要关注点之一。
本系统的起点就是数据及其关系。
在描述模型前，插一个话题，就是系统对数据的访问和操作。其结构如下图：
![数据源连接](https://github.com/blueskylong/aolie_illustrate/blob/master/images/core/dboper.png)

系统开发中数据来源最多的算是数据库，但也可以是文件，其它数据服务等。就数据库而言也是存在很多种的，所以在数据持久层抽取一个接口是自然的想法。
这里抽了二层，下层```IDataOperator```，上一层```IDbHandler```。
```IDataOperator```直接面向数据库，其参数都已翻译成查询描述。
```IDbHandler```接口则面向方案，其参数都以方案为基础。承担着语义转换的角色，增加这层的目的，是为了能更好的理解数据库操作的逻辑，从而通过拦截器，来修改相应的行为。
如权限拦截器，就需要在原始的查询条件中，插入权限相关的条件。
> 由于对数据库的操作语义很复杂，基于方案的操作描述，还不能完全覆盖SQL语句所能表达的语义，只能说目前可以实现主要部分。
> 其它复杂的数据库操作，框架提供二种方式：
>1. 向操作参数提供```SqlExp```值，这是一个SQL语句的简单包装类。
>2. 定义Sql语句文件，通过```SqlLoader```加载执行。

> 只能说这是设计的远景架构，目前也只实现了MyBatis的数据库操作。在构想中有比较多的难点，如多数据源条件判断，结果合并，分页,更新操作的事务处理等。

一、模型 
![数据模型](https://github.com/blueskylong/aolie_illustrate/blob/master/images/schema.png)
模型设计是这个框架的基础。模型中有以下几个元素：方案，表，列，关系，约束，公式。
模型负责逻辑属性的设置。
**方案**：是围绕一个业务的一系列表的集合。分方案的目的，一是划分出不同的业务，将变化与不常变化的部分分开。二是减少设计时的复杂度，如果所有表都在一个方案中实现，则设计时会很杂乱。三、为以后的业务迁移带来便利。
**表**：对应数据库的表或视图，表可以指定数据源，关联默认的展示界面
**列**：对应数据库的表或视图列。列具有类型，长度，标题，字段名，公式，**引用**等属性。
**引用**：引用是另一种表关系的表达。作为引用的表（或数据），具有数据基本固定，数据量小，多处引用的特点。引用具有全局性，就是所有方案里的表，都可以选择。引用固定在“全局引用方案”中定义。
**关系**：表与表之间的关系属性，可以是一对一，一对多，及多对多。其中 如0-1对1，一对0-多，这种情况，是通过关联字段是否不可为空为依据。如果关联字段不可以为空，则不带0，如果可以为空，则带上0.其影响是在删除时，是将关联列置成空，还是级联删除。
**约束**：指表与表之间的逻辑关联，例如 a表某列的和必须大于等于b表某列的和。即可是表内的约束，也可以是表间的约束。如果是表间的，则要求二表具有关联关系。约束通过表达式设置。
**公式**：包含表内公式和表间公式。如果是表间公司，则二表间需要有关联关系。表的一个列，可以具有多个公式，每个公式都可以设置条件，只有当条件为真时，才会计算当前的公式。公式有优先级，从高到低进行计算，遇到符合条件的公式，则停止继续遍历。
> 在公式，约束，及界面中的可见条件，使能条件中，都使用到了表达式，本系统的表达式使用了自制的解释器，仅支持指定的几种表达式元素，如：操作符： +-*/，小括号，逻辑符 并且，或者，条件：以XX结尾，以XX开始，不等于，不于，不含有，含有，不于等于，小于等于，等于，小于，大于，为空，
>和分组函数：平均值，加和，计数，最小，最大等。当前是自定义的判断，后期有时间将修改成javaCC，以便更具扩展性。
![表达式](https://github.com/blueskylong/aolie_illustrate/blob/master/images/core/formula.png)
![表达式](https://github.com/blueskylong/aolie_illustrate/blob/master/images/core/formula2.png)


二、界面设计 
界面设计，主要负责显示属性的设置，在显示时，会结合模型的设置，来控制表单中控件的行为。
界面设计器，是设计数据展示的方式，目前提供四种常见的展示方式。
1. 表单
![表单设计](https://github.com/blueskylong/aolie_illustrate/blob/master/images/core/form.png)
当前表单的设计中，可以使用比较常用的几个输入框。但框架也支持用户自定义控件，这个其它文档再继续详述。表单上的控件与数据库中的字段对应，例外的情况是，Panel控件不需要有实体列对应，它属于容器型控件，可以挂接子控件。
表单中的控件，可以选择控件的类型，及显示的一些属性，如标题，标题颜色，位置，大小等。表单只显示一行表记录。
 > 具有引用数据的列，设置成“选择框”控件时，系统会自动生成选择信息。
 > “隐藏”类型的控件，只在设计期可见。

表单的布局分为二种，一是BootStrap的12列布局，这是默认的布局方式，另一种是固定位置布局，需要设置每一具

2. 表格
![表格设计](https://github.com/blueskylong/aolie_illustrate/blob/master/images/core/table.png)
表格的设计与表单类似，将树状结构的表头信息，展示成表格。可设置列的宽度，显示格式等信息。

3. 树
![树设计](https://github.com/blueskylong/aolie_illustrate/blob/master/images/core/tree.png)
如果计划将数据以树形式展示，则可以选择默认显示方式为树。树显示方式的设计与表单设计共用一个设计器，只是必须指定建树的相关信息，如Id字段，编码字段，名称字段和父节点字段。其中编码字段和父节点字段，二选一即可，前者是以编码的方式（编码规则3-3-3-3-3）形成树结构，后者则是通过ID和parentId来生成树结构。

4. 卡片
![卡片设计](https://github.com/blueskylong/aolie_illustrate/blob/master/images/core/card.png)
卡片是表单和表格特性的一个延伸控件，它即详细显示一行数据，又在整体显示多行数据。卡片的具有删除行，和排序的额外功能。其设计界面也使用表单设计器。

三、页面设计
![页面设计](https://github.com/blueskylong/aolie_illustrate/blob/master/images/pagedesign.png)
页面设计，是将各界面按边框布局（BorderLayout）进行组合。 页面可以嵌套定义，就是一个页面，可以嵌套另一个页面，以组成一个较复杂的页面。布局中的中间块必须要设置显示的元素。其它块都可以为空。
每个块可以引用3种元素，1. 界面设计中的界面，2. 页面。3.自定义视图，4.使用“引用”作为树显示在相关位置。
>自定义视图需要继承于BaseUI<PageDetailDto>，设置时，先在视图树上拖拽“自定义视图”的节点到相应的位置上，然后在明细属性的表单中填写“自定义类”属性的值。

四、菜单管理
![菜单管理](https://github.com/blueskylong/aolie_illustrate/blob/master/images/menu.png)
菜单是定义显示给用户操作的功能。菜单对应的功能来源有二个，一是页面设计器中设计的页面，通过选择关联，二是用户自定义的菜单功能，使用填写“功能名”来指定。
给菜单增加按钮，默认的系统按钮，是依附于数据表的，一个内置的按钮，对应数据源一种操作，如编辑，新增，删除等。按钮会根据界面的类型，分配到各个界面中。

通过这四步，便可设置出完成的功能。

**完全通过配置完成的功能，能做什么。**
1. 数据联动。
数据的联动是根据数据表关系确定的，如：选择“引用”生成树，如果一数据表引用了此引用，则此数据表生成表格，会自己根据选择的数据进行过滤，又如：如果选择数据表中的一行数据，则如果有明细表单，则表单的数据会根据选择自动刷新等。
数据联动还表现在，如果修改了数据，则相关界面会自动刷新。
2. 公式计算
表单数据会根据配置的公式实时计算，界面中的控件使能和可见条件，也会实时计算，并刷新显示。
3. 前后端数据检查
前端数据提交前，会根据配置做验证，数据传到后端时会依据设置的规则再完整验证一次。
4. 状态管理
一个数据表可以有多个状态，如编辑，查看等，数据表状态的变化，会影响同界面其它界面的状态。如，一个数据源在编辑，则其它数据源可能就不可以再变动，直到引数据源保存或取消。
5. 响应插件
可以接受新增加的插件。如定义的表格，在应用了流程插件时，如果此表的数据源存在流程，会动态增加流程状态列。
6. 操作界面和方法保持一致性。
界面风格保持一致，包括按钮的位置，操作的行为等。

在不完成使用配置完成的功能，也可以获得框架中的功能。
这要分几个应用的层次：
1. 仅引用界面。
在自定义的功能中，通过 Form.getInstance(viewID)，或都其它组件，可以直接生成界面设计器设计出来的组件，组件会有公式，约束等功能。
2. 自定义部分组件，在页面设计中引用
自定义组件，可以实现```AutoManagedUI```接口，并响应接口方法，则整体的功能会由框架管理。你只需要关注自定义的逻辑即可。
3. 继承```ManagedFunc```类，功能完全使用系统定义，在自定义类中，可以取得组件，增加或修改其行为。这样，只修改特殊的需求，其它交给框架管理
三种方式可以混合使用。最不济的，就是完全手动写功能了。

以上部分，就完成了从数据模型到菜单功能的转换过程，数据模型中，还有很多属性在此还没有介绍，如引用的应用，插件方式开发等，会在后续的文档中介绍。